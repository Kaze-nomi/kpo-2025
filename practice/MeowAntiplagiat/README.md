# Система антиплагиата HSE

## Архитектура проекта

В ходе реализации проекта были реализованы следующие микросервисы:

1. **API Gateway (hse.api)**
   - REST API сервис на Spring Boot
   - Обеспечивает взаимодействие с клиентами через HTTP
   - Использование Swagger для документации API
   - Основные функции:
     - Загрузка файлов
     - Получение содержимого файлов
     - Инициирование анализа
     - Получение результатов

2. **File Storing Service (hse.storing)**
   - Основные функции:
     - Уникальная идентификация файлов по хешу
     - Предотвращение дубликатов (плагиат не пройдёт)
     - Хранение метаданных в БД
     - Сохранение файлов в локальное хранилище

3. **File Analysis Service (hse.analysis)**
   - Основные функции:
     - Анализ текста (подсчёт символов, слов, параграфов)
     - Генерация облака слов через quickchart.io
     - Хранение результатов анализа в БД
     - Сохранение облаков слов в локальное хранилище

---

## Особенности реализцаии

- В File Storing БД хранятся ID, имя, хеш содержимого, location файла

- В File Analysis БД хранятся ID, результаты анализа, location облака слов

- ID файлов в БД начинаются с 1

- ID файлов в File Analysis БД соответствуют ID файлов в File Storing БД (если поступит запрос с уже использованным ID, информация в старой ячейке перезапишется)

- Сами файлы сохраняются в тома задаваемые через docker-compose

- Для связи между микросервисами был использован gRPC

- Для микросервисов были реализованы retry-механизмы (для общения), чтобы обеспечить надежность системы

- Сравнение файлов происходит по содержанию (используется хеш содержимого), но не по имени (если содержание разное, а имена одинаковые система присвоит файлу новое уникальное имя)

- Проброс ошибок от самого низкого уровня вверх у каждого сервиса

- Размер входного файла не должен превышать 4 МБ (хотя облако слов перестанет генерироваться гораздо раньше)

- Для больших текстов quickchart.io отказывается генеририровать облака слов

- Облака слов в формате PNG

- Если облако слов не было сгенерировано, то в поле cloudLocation в БД будет записан null, а пользователь при завершении анализа получит соответствующее сообщение с ошибкой (при этом сам анализ будет сохранён)

- Покрытие тестами 90+ процентов кода (через плагин jacoco)

---

## Документация

### Требования

Для работы системы должны быть свободными порты 8080, 9091, 9092

### Unit-тесты

Для запуска unit-тестов можно воспользоваться командой ./gradlew jacocoCombinedReport (из корневой директории), которая запускает тесты сразу из всех микросервисов и генерирует отчёт в html-формате по пути build/reports/jacoco/jacocoCombinedReport/index.html

Также можно запустить тесты отедльно для каждого из микросервисов командой ./gradlew test (но зачем? Я же так старался написать эту задачу по склеиванию репортов в один...)

### Запуск

1. Для запуска всех микросервисов нужно запусить docker-compose из root директории, командой docker-compose up (перед этим прописав docker-compose build), также можно запускать отдельно каждый микросервис (docker-compose up api-gateway file-storing-service и т.д.) 

2. Для тестирования API можно воспользоваться Swagger по ссылке http://localhost:8080/swagger-ui/index.html

### Завершение работы

Для завершения работы всех микросервисов нужно ввести команду docker-compose down (если требуется очистить БД и тома то docker-compose down -v)

### Use Cases

#### Загрузка текстового файла

**Цель:** Сохранить текстовый файл в системе

**Участники:**

- API Gateway

- File Storing Service

**Требования:**

- Файл имеет расширение .txt

- Содержание файла не пустое

- Размер файла ≤ 4 МБ

**Основной сценарий:**

1. Пользователь отправляет файл через /upload эндпоинт

2. Система проверяет формат файла

3. File Storing Service вычисляет хеш содержимого:

   - Если файл с таким хешем присутствует в БД → возвращает существующий ID и сообщение о поимке недобросовестного студента

   - Если файл новый → сохраняет соответствующие данные в локальное хранилище и в БД и генерирует новый ID

4. Пользователь получает уникальный ID файла

#### Получение содержимого файла

**Цель:** Получить содержимое ранее загруженного файла

**Участники:**

- API Gateway

- File Storing Service

**Требования:**

- Файл с указанным ID существует

**Основной сценарий:**

1. Пользователь запрашивает файл через /storing/{id}

2. File Storing Service берёт location файла из БД, находит файл и возвращает содержимое файла в виде текста

3. Пользователь получает содержимое файла

#### Анализ файла

**Цель:** Получить статистику по файлу (символы, слова, параграфы) и облако слов

**Участники:**

- API Gateway

- File Analysis Service

- File Storing Service

- quickchart.io

**Основной сценарий:**

1. Пользователь инициирует анализ через /analysis/{id}

2. File Analysis Service:

   - Если анализ файла с таким ID существует → возвращает существующий анализ

   - Иначе отправляет запрос к File Storing Service на получение файла по ID

   - Считает символы, слова и параграфы

   - Отправляет запрос на генерацию облака слов на quickchart.io

   - Результаты сохраняются в БД вне зависимости от успеха получения облака слов

3. Пользователь получает анализ файла

#### Получение облака слов

**Цель:** Получить картинку облака слов

**Участники:**

- API Gateway

- File Analysis Service

**Требования:**

- Анализ файла был выполнен

- Облако слов успешно сгенерировано

**Основной сценарий:**

1. Пользователь запрашивает облако через /analysis/wordcloud/{fileId}

2. Система возвращает PNG-изображение

3. Пользователь получает картинку облака слов

--

## Итог

В рамках выполнения проекта были реализованы:

- API Gateway, который принимает запросы на загрузку файлов, получение содержимого файлов, анализ файлов и получение облаков слов

- File Storing Service, который хранит файлы в локальном хранилище, а также хранит информацию о файлах в БД

- File Analysis Service, который анализирует файлы, хранит результаты анализа в БД и генерирует облака слов

- Swagger UI, который позволяет работать с API в удобном виде

- Docker-compose, который собирает и запускает микросервисы

- Unit-тесты, которые проверяют корректность работы микросервисов

- jacoco, который собирает отчёт о покрытии кода тестами

- quickchart.io, который генерирует облака слов

- README.md, который документирует всё вышеописанное